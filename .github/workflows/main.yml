name: Deploy Node.js Azure Function App

on:
    push:
    workflow_dispatch:

# Environment variables that can be customized
env:
    AZURE_FUNCTIONAPP_NAME: 'postech-fiap-serverless'
    AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'
    NODE_VERSION: '20.x'

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            # Checkout the repository
            - name: 'Checkout GitHub Action'
              uses: actions/checkout@v4

            # Setup Node.js environment
            - name: 'Setup Node ${{ env.NODE_VERSION }} Environment'
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            # Install dependencies
            - name: 'Resolve Project Dependencies'
              shell: bash
              run: |
                pushd '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
                npm install
                npm run build --if-present
                npm run test --if-present
                popd

            # Deploy to Azure Function App
            - name: 'Azure Functions Action'
              uses: Azure/functions-action@v1
              id: fa
              with:
                  app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
                  publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
                  package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
